function UintToInt(t,a){return 2===a&&(32768&t)>0&&(t-=65536),3===a&&(8388608&t)>0&&(t-=16777216),4===a&&(2147483648&t)>0&&(t-=4294967296),t}function Bytes2Float32(t){let a=2147483648&t?-1:1,e=(t>>23&255)-127,i=8388607&t;if(128==e)return a*(i?Number.NaN:Number.POSITIVE_INFINITY);if(-127==e){if(0==i)return 0;e=-126,i/=1<<23}else i=(i|1<<23)/(1<<23);return a*i*Math.pow(2,e)}function BytesToInt64(t,a,e,i){void 0===i&&(i=!1);let s,l,o="U"!=e.substr(0,1),d=parseInt(e.substr(1,2),10)/8,r=d;for(i?(s=-1,l=a+d-1):s=1,l=a,tmpInt64=0,j=l;r>0;j+=s,r--)tmpInt64=(tmpInt64<<8)+t[j];return o&&d<8&&128&t[l]&&(tmpInt64-=1<<8*d),tmpInt64}function decimalToHex(t,a){let e=t.toString(16).toUpperCase();for(a=null==a?a=2:a;e.length<a;)e="0"+e;return"0x"+e}function parseHexString(t){let a=[];for(;t.length>=2;)a.push(parseInt(t.substring(0,2),16)),t=t.substring(2,t.length);return a}function Decoder(t,a){let e={lora:{}};e.lora.port=a;let s=t.length,l="";e.lora.payload="";for(let a=0;a<s;a++){l=t[a].toString(16).toUpperCase(),1===l.length&&(l="0"+l),e.lora.payload+=l;let i=new Date;e.lora.date=i.toISOString()}if(125===a)if(batch=!(1&t[0]),!1===batch){if(e.zclheader={},e.zclheader.report="standard",attID=-1,cmdID=-1,clustID=-1,e.zclheader.endpoint=(224&t[0])>>5|(6&t[0])<<2,cmdID=t[1],e.zclheader.cmdID=decimalToHex(cmdID,2),clustID=256*t[2]+t[3],e.zclheader.clustID=decimalToHex(clustID,4),10===cmdID|138===cmdID|1===cmdID){if(e.data={},attID=256*t[4]+t[5],e.zclheader.attID=decimalToHex(attID,4),138===cmdID&&(e.zclheader.alarm=1),10===cmdID|138===cmdID&&(i1=7),1===cmdID&&(i1=8,e.zclheader.status=t[6]),1026===clustID&0===attID&&(e.data.temperature=UintToInt(256*t[i1]+t[i1+1],2)/100),1029===clustID&0===attID&&(e.data.humidity=(256*t[i1]+t[i1+1])/100),15===clustID&1026===attID&&(e.data.counter=256*t[i1]*256*256+256*t[i1+1]*256+256*t[i1+2]+t[i1+3]),15===clustID&85===attID&&(e.data.pin_state=!!t[i1]),19===clustID&85===attID&&(e.data.value=t[i1]),6===clustID&0===attID&&(state=t[i1],1===state?e.data.state="ON":e.data.state="OFF"),32776===clustID&0===attID&&(e.data.differential_pressure=256*t[i1]+t[i1+1]),32773===clustID&0===attID&&(e.data.pin_state_1=1==(1&t[i1+1]),e.data.pin_state_2=2==(2&t[i1+1]),e.data.pin_state_3=4==(4&t[i1+1]),e.data.pin_state_4=8==(8&t[i1+1]),e.data.pin_state_5=16==(16&t[i1+1]),e.data.pin_state_6=32==(32&t[i1+1]),e.data.pin_state_7=64==(64&t[i1+1]),e.data.pin_state_8=128==(128&t[i1+1]),e.data.pin_state_9=1==(1&t[i1]),e.data.pin_state_10=2==(2&t[i1])),12===clustID&85===attID&&(e.data.analog=Bytes2Float32(256*t[i1]*256*256+256*t[i1+1]*256+256*t[i1+2]+t[i1+3])),32775===clustID&1===attID){e.data.payload="",e.data.modbus_payload="",e.data.size=t[i1],e.data.modbus_float=0;for(let a=0;a<e.data.size;a++)l=t[i1+a+1].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.payload+=l,0==a?e.data.modbus_address=t[i1+a+1]:1==a?e.data.modbus_commandID=t[i1+a+1]:2==a?e.data.modbus_size=t[i1+a+1]:(e.data.modbus_payload+=l,1==e.data.modbus_float&&(3==a&&(e.data.fregister_00=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),7==a&&(e.data.fregister_01=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),11==a&&(e.data.fregister_02=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),15==a&&(e.data.fregister_03=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),19==a&&(e.data.fregister_04=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),23==a&&(e.data.fregister_05=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),27==a&&(e.data.fregister_06=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),31==a&&(e.data.fregister_07=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),35==a&&(e.data.fregister_08=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3])),35==a&&(e.data.fregister_09=Bytes2Float32(256*t[i1+a+1]*256*256+256*t[i1+a+1+1]*256+256*t[i1+a+1+2]+t[i1+a+1+3]))),2==e.data.modbus_float&&(3==a&&(e.data.fregister_00=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),7==a&&(e.data.fregister_01=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),11==a&&(e.data.fregister_02=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),15==a&&(e.data.fregister_03=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),19==a&&(e.data.fregister_04=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),23==a&&(e.data.fregister_05=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),27==a&&(e.data.fregister_06=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),31==a&&(e.data.fregister_07=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),35==a&&(e.data.fregister_08=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256)),35==a&&(e.data.fregister_09=Bytes2Float32(256*t[i1+a+1]+t[i1+a+1+1]+256*t[i1+a+1+2]*256*256+256*t[i1+a+1+3]*256))))}if(32777===clustID&0===attID){if(e.data.payloads="",e.data.size=t[i1],e.data.multimodbus_frame_series_sent=t[i1+1],e.data.multimodbus_frame_number_in_serie=(224&t[i1+2])>>5,e.data.multimodbus_last_frame_of_serie=(28&t[i1+2])>>2,e.data.multimodbus_EP9=1==(1&t[i1+2]),e.data.multimodbus_EP8=2==(2&t[i1+2]),e.data.multimodbus_EP7=128==(128&t[i1+3]),e.data.multimodbus_EP6=64==(64&t[i1+3]),e.data.multimodbus_EP5=32==(32&t[i1+3]),e.data.multimodbus_EP4=16==(16&t[i1+3]),e.data.multimodbus_EP3=8==(8&t[i1+3]),e.data.multimodbus_EP2=4==(4&t[i1+3]),e.data.multimodbus_EP1=2==(2&t[i1+3]),e.data.multimodbus_EP0=1==(1&t[i1+3]),i2=i1+4,without_header=0,!0===e.data.multimodbus_EP0){if(0===without_header&&(e.data.multimodbus_EP0_slaveID=t[i2],i2+=1,e.data.multimodbus_EP0_fnctID=t[i2],i2+=1,e.data.multimodbus_EP0_datasize=t[i2],i2+=1),e.data.multimodbus_EP0_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP0_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP0_payload+=l;i2+=e.data.multimodbus_EP0_datasize}if(!0===e.data.multimodbus_EP1){if(0===without_header&&(e.data.multimodbus_EP1_slaveID=t[i2],i2+=1,e.data.multimodbus_EP1_fnctID=t[i2],i2+=1,e.data.multimodbus_EP1_datasize=t[i2],i2+=1),e.data.multimodbus_EP1_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP1_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP1_payload+=l;i2+=e.data.multimodbus_EP1_datasize}if(!0===e.data.multimodbus_EP2){if(0===without_header&&(e.data.multimodbus_EP2_slaveID=t[i2],i2+=1,e.data.multimodbus_EP2_fnctID=t[i2],i2+=1,e.data.multimodbus_EP2_datasize=t[i2],i2+=1),e.data.multimodbus_EP2_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP2_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP2_payload+=l;i2+=e.data.multimodbus_EP2_datasize}if(!0===e.data.multimodbus_EP3){if(0===without_header&&(e.data.multimodbus_EP3_slaveID=t[i2],i2+=1,e.data.multimodbus_EP3_fnctID=t[i2],i2+=1,e.data.multimodbus_EP3_datasize=t[i2],i2+=1),e.data.multimodbus_EP3_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP3_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP3_payload+=l;i2+=e.data.multimodbus_EP3_datasize}if(!0===e.data.multimodbus_EP4){if(0===without_header&&(e.data.multimodbus_EP4_slaveID=t[i2],i2+=1,e.data.multimodbus_EP4_fnctID=t[i2],i2+=1,e.data.multimodbus_EP4_datasize=t[i2],i2+=1),e.data.multimodbus_EP4_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP4_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP4_payload+=l;i2+=e.data.multimodbus_EP4_datasize}if(!0===e.data.multimodbus_EP5){if(0===without_header&&(e.data.multimodbus_EP5_slaveID=t[i2],i2+=1,e.data.multimodbus_EP5_fnctID=t[i2],i2+=1,e.data.multimodbus_EP5_datasize=t[i2],i2+=1),e.data.multimodbus_EP5_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP5_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP5_payload+=l;i2+=e.data.multimodbus_EP5_datasize}if(!0===e.data.multimodbus_EP6){if(0===without_header&&(e.data.multimodbus_EP6_slaveID=t[i2],i2+=1,e.data.multimodbus_EP6_fnctID=t[i2],i2+=1,e.data.multimodbus_EP6_datasize=t[i2],i2+=1),e.data.multimodbus_EP6_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP6_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP6_payload+=l;i2+=e.data.multimodbus_EP6_datasize}if(!0===e.data.multimodbus_EP7){if(0===without_header&&(e.data.multimodbus_EP7_slaveID=t[i2],i2+=1,e.data.multimodbus_EP7_fnctID=t[i2],i2+=1,e.data.multimodbus_EP7_datasize=t[i2],i2+=1),e.data.multimodbus_EP7_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP7_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP7_payload+=l;i2+=e.data.multimodbus_EP7_datasize}if(!0===e.data.multimodbus_EP8){if(0===without_header&&(e.data.multimodbus_EP8_slaveID=t[i2],i2+=1,e.data.multimodbus_EP8_fnctID=t[i2],i2+=1,e.data.multimodbus_EP8_datasize=t[i2],i2+=1),e.data.multimodbus_EP8_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP8_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP8_payload+=l;i2+=e.data.multimodbus_EP8_datasize}if(!0===e.data.multimodbus_EP9){if(0===without_header&&(e.data.multimodbus_EP6_slaveID=t[i2],i2+=1,e.data.multimodbus_EP6_fnctID=t[i2],i2+=1,e.data.multimodbus_EP6_datasize=t[i2],i2+=1),e.data.multimodbus_EP6_payload="",void 0===t[i2])return e;for(let a=0;a<e.data.multimodbus_EP6_datasize;a++)l=t[i2+a].toString(16).toUpperCase(),1==l.length&&(l="0"+l),e.data.multimodbus_EP6_payload+=l;i2+=e.data.multimodbus_EP6_datasize}}82===clustID&0===attID&&(e.data.active_energy_Wh=UintToInt(256*t[i1+1]*256+256*t[i1+2]+t[i1+3],3),e.data.reactive_energy_Varh=UintToInt(256*t[i1+4]*256+256*t[i1+5]+t[i1+6],3),e.data.nb_samples=256*t[i1+7]+t[i1+8],e.data.active_power_W=UintToInt(256*t[i1+9]+t[i1+10],2),e.data.reactive_power_let=UintToInt(256*t[i1+11]+t[i1+12],2)),32772===clustID&0===attID&&(1===t[i1]&&(e.data.message_type="confirmed"),0===t[i1]&&(e.data.message_type="unconfirmed")),32772===clustID&1===attID&&(e.data.nb_retry=t[i1]),32772===clustID&2===attID&&(e.data.period_in_minutes=256*t[i1+1]+t[i1+2],e.data.nb_err_frames=256*t[i1+3]+t[i1+4]),80===clustID&&6===attID&&(i2=i1+3,1==(1&t[i1+2])&&(e.data.main_or_external_voltage=(256*t[i2]+t[i2+1])/1e3,i2+=2),2==(2&t[i1+2])&&(e.data.rechargeable_battery_voltage=(256*t[i2]+t[i2+1])/1e3,i2+=2),4==(4&t[i1+2])&&(e.data.disposable_battery_voltage=(256*t[i2]+t[i2+1])/1e3,i2+=2),8==(8&t[i1+2])&&(e.data.solar_harvesting_voltage=(256*t[i2]+t[i2+1])/1e3,i2+=2),16==(16&t[i1+2])&&(e.data.tic_harvesting_voltage=(256*t[i2]+t[i2+1])/1e3,i2+=2)),32778===clustID&&0===attID&&(i2=i1,e.data.sum_positive_active_energy_Wh=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.sum_negative_active_energy_Wh=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.sum_positive_reactive_energy_Wh=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.sum_negative_reactive_energy_Wh=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.positive_active_power_W=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.negative_active_power_W=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.positive_reactive_power_W=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4),i2+=4,e.data.negative_reactive_power_W=UintToInt(256*t[i2+1]*256*256+256*t[i2+2]*256+256*t[i2+3]+t[i2+4],4)),32784===clustID&0===attID?(e.data.ActiveEnergyWhPhaseA=Int32UnsignedToSigned(256*t[i1+1]*256*256+256*t[i1+2]*256+256*t[i1+3]+t[i1+4]),e.data.ReactiveEnergyWhPhaseA=Int32UnsignedToSigned(256*t[i1+5]*256*256+256*t[i1+6]*256+256*t[i1+7]+t[i1+8]),e.data.ActiveEnergyWhPhaseB=Int32UnsignedToSigned(256*t[i1+9]*256*256+256*t[i1+10]*256+256*t[i1+11]+t[i1+12]),e.data.ReactiveEnergyWhPhaseB=Int32UnsignedToSigned(256*t[i1+13]*256*256+256*t[i1+14]*256+256*t[i1+15]+t[i1+16]),e.data.ActiveEnergyWhPhaseC=Int32UnsignedToSigned(256*t[i1+17]*256*256+256*t[i1+18]*256+256*t[i1+19]+t[i1+20]),e.data.ReactiveEnergyWhPhaseC=Int32UnsignedToSigned(256*t[i1+21]*256*256+256*t[i1+22]*256+256*t[i1+23]+t[i1+24]),e.data.ActiveEnergyWhPhaseABC=Int32UnsignedToSigned(256*t[i1+25]*256*256+256*t[i1+26]*256+256*t[i1+27]+t[i1+28]),e.data.ReactiveEnergyWhPhaseABC=Int32UnsignedToSigned(256*t[i1+29]*256*256+256*t[i1+30]*256+256*t[i1+31]+t[i1+32])):32784===clustID&1===attID&&(e.data.ActivePowerWPhaseA=Int32UnsignedToSigned(256*t[i1+1]*256*256+256*t[i1+2]*256+256*t[i1+3]+t[i1+4]),e.data.ReactivePowerWPhaseA=Int32UnsignedToSigned(256*t[i1+5]*256*256+256*t[i1+6]*256+256*t[i1+7]+t[i1+8]),e.data.ActivePowerWPhaseB=Int32UnsignedToSigned(256*t[i1+9]*256*256+256*t[i1+10]*256+256*t[i1+11]+t[i1+12]),e.data.ReactivePowerWPhaseB=Int32UnsignedToSigned(256*t[i1+13]*256*256+256*t[i1+14]*256+256*t[i1+15]+t[i1+16]),e.data.ActivePowerWPhaseC=Int32UnsignedToSigned(256*t[i1+17]*256*256+256*t[i1+18]*256+256*t[i1+19]+t[i1+20]),e.data.ReactivePowerWPhaseC=Int32UnsignedToSigned(256*t[i1+21]*256*256+256*t[i1+22]*256+256*t[i1+23]+t[i1+24]),e.data.ActivePowerWPhaseABC=Int32UnsignedToSigned(256*t[i1+25]*256*256+256*t[i1+26]*256+256*t[i1+27]+t[i1+28]),e.data.ReactivePowerWPhaseABC=Int32UnsignedToSigned(256*t[i1+29]*256*256+256*t[i1+30]*256+256*t[i1+31]+t[i1+32])),32779===clustID&0===attID&&(i2=i1,e.data.Vrms=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.Irms=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.phase_angle=UintToInt(256*t[i2+1]+t[i2+2],2)),32781===clustID&0===attID&&(e.data.VrmsA=UintToInt(256*t[i1+1]+t[i1+2],2)/10,e.data.IrmsA=UintToInt(256*t[i1+3]+t[i1+4],2)/10,e.data.PhaseA=UintToInt(256*t[i1+5]+t[i1+6],2),e.data.VrmsB=UintToInt(256*t[i1+7]+t[i1+8],2)/10,e.data.IrmsB=UintToInt(256*t[i1+9]+t[i1+10],2)/10,e.data.PhaseB=UintToInt(256*t[i1+11]+t[i1+12],2),e.data.VrmsC=UintToInt(256*t[i1+13]+t[i1+14],2)/10,e.data.IrmsC=UintToInt(256*t[i1+15]+t[i1+16],2)/10,e.data.PhaseC=UintToInt(256*t[i1+17]+t[i1+18],2)),32780===clustID&0===attID&&(e.data.Concentration=256*t[i1]+t[i1+1]),1024===clustID&0===attID&&(e.data.Illuminance=256*t[i1]+t[i1+1]),1027===clustID&0===attID&&(e.data.Pressure=UintToInt(256*t[i1]+t[i1+1],2)),1030===clustID&0===attID&&(e.data.Occupancy=!!t[i1]),32850===clustID&0===attID&&(i2=i1,e.data.frequency=(UintToInt(256*t[i2+1]+t[i2+2],2)+22232)/1e3,i2+=2,e.data.frequency_min=(UintToInt(256*t[i2+1]+t[i2+2],2)+22232)/1e3,i2+=2,e.data.frequency_max=(UintToInt(256*t[i2+1]+t[i2+2],2)+22232)/1e3,i2+=2,e.data.Vrms=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.Vrms_min=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.Vrms_max=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.Vpeak=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.Vpeak_min=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.Vpeak_max=UintToInt(256*t[i2+1]+t[i2+2],2)/10,i2+=2,e.data.over_voltage=UintToInt(256*t[i2+1]+t[i2+2],2),i2+=2,e.data.sag_voltage=UintToInt(256*t[i2+1]+t[i2+2],2)),32783===clustID&&(i=i1+1,0===attID?(o=e.data.Last={},o.NbTriggedAcq=BytesToInt64(t,i,"U32"),i+=4,o.Mean_X_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Max_X_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Dt_X_ms=BytesToInt64(t,i,"U16"),i+=2,o.Mean_Y_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Max_Y_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Dt_Y_ms=BytesToInt64(t,i,"U16"),i+=2,o.Mean_Z_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Max_Z_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Dt_Z_ms=BytesToInt64(t,i,"U16")):1===attID||2===attID||3===attID?(ext=1===attID?"Stats_X":2===attID?"Stats_Y":"Stats_Z",o=e.data[ext]={},o.NbAcq=BytesToInt64(t,i,"U16"),i+=2,o.MinMean_G=BytesToInt64(t,i,"U16")/100,i+=2,o.MinMax_G=BytesToInt64(t,i,"U16")/100,i+=2,o.MinDt=BytesToInt64(t,i,"U16"),i+=2,o.MeanMean_G=BytesToInt64(t,i,"U16")/100,i+=2,o.MeanMax_G=BytesToInt64(t,i,"U16")/100,i+=2,o.MeanDt=BytesToInt64(t,i,"U16"),i+=2,o.MaxMean_G=BytesToInt64(t,i,"U16")/100,i+=2,o.MaxMax_G=BytesToInt64(t,i,"U16")/100,i+=2,o.MaxDt=BytesToInt64(t,i,"U16"),i+=2):32768===attID&&(o=e.data.Params={},o.WaitFreq_Hz=BytesToInt64(t,i,"U16")/10,i+=2,o.AcqFreq_Hz=BytesToInt64(t,i,"U16")/10,i+=2,delay=BytesToInt64(t,i,"U16"),i+=2,32768&delay&&(delay=60*(-32769&delay)),o.NewWaitDelay_s=32768&delay?delay=60*(-32769&delay):delay,o.MaxAcqDuration_ms=BytesToInt64(t,i,"U16"),i+=2,o.Threshold_X_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Threshold_Y_G=BytesToInt64(t,i,"U16")/100,i+=2,o.Threshold_Z_G=BytesToInt64(t,i,"U16")/100,i+=2,o.OverThrsh_Dt_ms=BytesToInt64(t,i,"U16"),i+=2,o.UnderThrsh_Dt_ms=BytesToInt64(t,i,"U16"),i+=2,o.Range_G=BytesToInt64(t,i,"U16")/100,i+=2,o.FilterSmoothCoef=BytesToInt64(t,i,"U8"),i+=1,o.FilterGainCoef=BytesToInt64(t,i,"U8"),i+=1,o=e.data.Params.WorkingModes={},o.SignalEachAcq=128&t[i]?"true":"false",o.RstAftStdRpt_X=1&t[i]?"true":"false",o.RstAftStdRpt_Y=2&t[i]?"true":"false",o.RstAftStdRpt_7=4&t[i]?"true":"false"))}7===cmdID&&(attID=256*t[6]+t[7],e.zclheader.attID=decimalToHex(attID,4),e.zclheader.status=t[4],e.zclheader.batch=t[5]),9===cmdID&&(attID=256*t[6]+t[7],e.zclheader.attID=decimalToHex(attID,4),e.zclheader.status=t[4],e.zclheader.batch=t[5],e.zclheader.attribut_type=t[8],e.zclheader.min={},128==(128&t[9])?(e.zclheader.min.value=256*(t[9]-128)+t[10],e.zclheader.min.unity="minutes"):(e.zclheader.min.value=256*t[9]+t[10],e.zclheader.min.unity="seconds"),e.zclheader.max={},128==(128&t[11])?(e.zclheader.max.value=256*(t[11]-128)+t[12],e.zclheader.max.unity="minutes"):(e.zclheader.max.value=256*t[11]+t[12],e.zclheader.max.unity="seconds"),e.lora.payload="")}else e.batch={},e.batch.report="batch";return e}function normalisation_standard(t,a){let e="",i=t.bytes;console.log(t);let s=Decoder(i,t.fPort);if(void 0!==s.zclheader&&s.zclheader.alarm&&(e="événement surveillé déclanché"),7===i[1]&&i[0]%2!=0)return{data:{variable:"configure reporting response status",value:s.zclheader.status,date:t.recvTime},warning:e};if(9===i[1])return{data:{variable:"read reporting configuration response status",value:s.zclheader.status,date:t.recvTime},warning:e};if(1===i[1])return void 0===s.zclheader.data?{data:{variable:"read reporting configuration response status",value:"no data",date:t.recvTime},warning:e}:{data:{variable:"read reporting configuration response status",value:s.zclheader.data,date:t.recvTime},warning:e};if(void 0!==s.zclheader){if(void 0!==a){let i=s.zclheader.endpoint,l=Object.keys(s.data)[0];return{data:{variable:a[l][i],value:s.data[l],date:t.recvTime},type:"standard",warning:e}}{let a=Object.keys(s.data)[0];return{data:{variable:a,value:s.data[a],date:t.recvTime},type:"standard",warning:e}}}return{type:s.batch.report,payload:s.lora.payload}}let ST_UNDEF=0,ST_BL=1,ST_U4=2,ST_I4=3,ST_U8=4,ST_I8=5,ST_U16=6,ST_I16=7,ST_U24=8,ST_I24=9,ST_U32=10,ST_I32=11,ST_FL=12,ST={};ST[ST_UNDEF]=0,ST[ST_BL]=1,ST[ST_U4]=4,ST[ST_I4]=4,ST[ST_U8]=8,ST[ST_I8]=8,ST[ST_U16]=16,ST[ST_I16]=16,ST[ST_U24]=24,ST[ST_I24]=24,ST[ST_U32]=32,ST[ST_I32]=32,ST[ST_FL]=32;let BR_HUFF_MAX_i1_TABLE=14,NUMBER_OF_SERIES=16,HUFF=[[{sz:2,lbl:0},{sz:2,lbl:1},{sz:2,lbl:3},{sz:3,lbl:5},{sz:4,lbl:9},{sz:5,lbl:17},{sz:6,lbl:33},{sz:7,lbl:65},{sz:8,lbl:129},{sz:10,lbl:512},{sz:11,lbl:1026},{sz:11,lbl:1027},{sz:11,lbl:1028},{sz:11,lbl:1029},{sz:11,lbl:1030},{sz:11,lbl:1031}],[{sz:7,lbl:111},{sz:5,lbl:26},{sz:4,lbl:12},{sz:3,lbl:3},{sz:3,lbl:7},{sz:2,lbl:2},{sz:2,lbl:0},{sz:3,lbl:2},{sz:6,lbl:54},{sz:9,lbl:443},{sz:9,lbl:441},{sz:10,lbl:885},{sz:10,lbl:884},{sz:10,lbl:880},{sz:11,lbl:1763},{sz:11,lbl:1762}],[{sz:4,lbl:9},{sz:3,lbl:5},{sz:2,lbl:0},{sz:2,lbl:1},{sz:2,lbl:3},{sz:5,lbl:17},{sz:6,lbl:33},{sz:7,lbl:65},{sz:8,lbl:129},{sz:10,lbl:512},{sz:11,lbl:1026},{sz:11,lbl:1027},{sz:11,lbl:1028},{sz:11,lbl:1029},{sz:11,lbl:1030},{sz:11,lbl:1031}]];function brUncompress(t,a,e,i){let s=initResult(),l=createBuffer(parseHexString(e)),o=generateFlag(l.getNextSample(ST_U8));s.batch_counter=l.getNextSample(ST_U8,3),l.getNextSample(ST_U8,1);let d=prePopulateOutput(s,l,a,o,t),r=d.last_timestamp,n=d.i1_of_the_first_sample;return o.hasSample&&(r=uncompressSamplesData(s,l,n,a,r,o,t)),s.batch_relative_timestamp=extractTimestampFromBuffer(l,r),adaptToExpectedFormat(s,a,i)}function initResult(){let t=[],a=0;for(;a<NUMBER_OF_SERIES;)t.push({codingType:0,codingTable:0,resolution:null,uncompressSamples:[]}),a+=1;return{batch_counter:0,batch_relative_timestamp:0,series:t}}function createBuffer(t){function a(t,a,e){let i=a,s=e-1;if(8*t.length<i+e)throw new Error("Batch : Verify that dest buf is large enough");let l=0,o=0;for(;e>0;)t[i>>3]&1<<(7&i)&&(o|=1<<s-l),e--,l++,i++;return o}return{i1:0,byteArray:t,getNextSample:function(t,a){let e=a||ST[t],i=this.i1;if(this.i1+=e,t===ST_FL&&32!==e)throw new Error("Batch : Mauvais sampletype");let s=0,l=Math.trunc((e-1)/8)+1,o=e%8;for(0===o&&l>0&&(o=8);l>0;){let t=0;for(;o>0;){let a=i>>3;this.byteArray[a]&1<<(7&i)&&(s|=1<<8*(l-1)+t),o--,t++,i+=1}l--,o=8}if((t==ST_I4||t==ST_I8||t==ST_I16||t==ST_I24)&&s&1<<e-1)for(let t=e;t<32;t++)s|=1<<t,e++;return s},getNextBifromHi:function(t){for(let e=2;e<12;e++){let i=a(this.byteArray,this.i1,e);for(let a=0;a<HUFF[t].length;a++)if(HUFF[t][a].sz==e&&i==HUFF[t][a].lbl)return this.i1+=e,a}throw new Error("Bi not found in HUFF table")}}}function generateFlag(t){let a=t.toString(2);for(;a.length<8;)a="0"+a;return{isCommonTimestamp:parseInt(a[a.length-2],2),hasSample:!parseInt(a[a.length-3],2),batch_req:parseInt(a[a.length-4],2),nb_of_type_measure:parseInt(a.substring(0,4),2)}}function prePopulateOutput(t,a,e,i,s){let l=0,o=0;for(let d=0;d<i.nb_of_type_measure;d++){let r={size:s,lbl:a.getNextSample(ST_U8,s)},n=findi1FromArgList(e,r);0===d&&(o=n),l=extractTimestampFromBuffer(a,l),t.series[n]=computeSeries(a,e[n].sampletype,r.lbl,l),i.hasSample&&(t.series[n].codingType=a.getNextSample(ST_U8,2),t.series[n].codingTable=a.getNextSample(ST_U8,2))}return{last_timestamp:l,i1_of_the_first_sample:o}}function computeSeries(t,a,e,i){return{uncompressSamples:[{data_relative_timestamp:i,data:{value:getMeasure(t,a),label:e}}],codingType:0,codingTable:0,resolution:null}}function findi1FromArgList(t,a){for(let e=0;e<t.length;e++)if(t[e].taglbl===a.lbl)return e;throw new Error("Batch : Cannot find i1 in argList")}function extractTimestampFromBuffer(t,a){if(a){let e=t.getNextBifromHi(1);return computeTimestampFromBi(t,a,e)}return t.getNextSample(ST_U32)}function computeTimestampFromBi(t,a,e){return e>BR_HUFF_MAX_i1_TABLE?t.getNextSample(ST_U32):e>0?computeTimestampFromPositiveBi(t,a,e):a}function computeTimestampFromPositiveBi(t,a,e){return t.getNextSample(ST_U32,e)+a+Math.pow(2,e)-1}function getMeasure(t,a){let e=t.getNextSample(a);return a===ST_FL?bytes2Float32(e):e}function bytes2Float32(t){let a=2147483648&t?-1:1,e=(t>>23&255)-127,i=8388607&t;if(128==e)return a*(i?Number.NaN:Number.POSITIVE_INFINITY);if(-127==e){if(0===i)return 0*a;e=-126,i/=1<<22}else i=(i|1<<23)/(1<<23);return a*i*Math.pow(2,e)}function uncompressSamplesData(t,a,e,i,s,l,o){return l.isCommonTimestamp?handleCommonTimestamp(t,a,e,i,l,o):handleSeparateTimestamp(t,a,i,s,l,o)}function handleCommonTimestamp(t,a,e,i,s,l){let o=a.getNextSample(ST_U8,8),d={},r=initTimestampCommonTable(t,a,o,e),n=r.timestampCommon,m=r.lastTimestamp;for(let e=0;e<s.nb_of_type_measure;e++){let e=1;d.lbl=a.getNextSample(ST_U8,l);let s=findi1FromArgList(i,d);for(let l=0;l<o;l++){if(a.getNextSample(ST_U8,1)){let o=a.getNextBifromHi(t.series[s].codingTable),d={data_relative_timestamp:0,data:{}};if(o<=BR_HUFF_MAX_i1_TABLE){let l=t.series[s].uncompressSamples[t.series[s].uncompressSamples.length-1].data.value;if(o>0)d.data.value=completeCurrentMeasure(a,l,t.series[s].codingType,i[s].resol,o);else{if(e){e=0;continue}d.data.value=l}}else d.data.value=a.getNextSample(i[s].sampletype);d.data_relative_timestamp=n[l],t.series[s].uncompressSamples.push(d)}}}return m}function initTimestampCommonTable(t,a,e,i){let s=[],l=0,o=a.getNextSample(ST_U8,2);for(let d=0;d<e;d++){let e=a.getNextBifromHi(o);if(e<=BR_HUFF_MAX_i1_TABLE)if(0===d)s.push(t.series[i].uncompressSamples[0].data_relative_timestamp);else if(e>0){let t=s[d-1];s.push(a.getNextSample(ST_U32,e)+t+Math.pow(2,e)-1)}else s.push(precedingTimestamp);else s.push(a.getNextSample(ST_U32));l=s[d]}return{timestampCommon:s,lastTimestamp:l}}function completeCurrentMeasure(t,a,e,i,s){let l=t.getNextSample(ST_U16,s);return 0===e?computeAdlcValue(l,i,a,s):1===e?(l+Math.pow(2,s)-1)*i+a:a-(l+(Math.pow(2,s)-1))*i}function computeAdlcValue(t,a,e,i){return t>=Math.pow(2,i-1)?t*a+e:(t+1-Math.pow(2,i))*a+e}function handleSeparateTimestamp(t,a,e,i,s,l){let o={};for(let d=0;d<s.nb_of_type_measure;d++){o.lbl=a.getNextSample(ST_U8,l);let s=findi1FromArgList(e,o),d=a.getNextSample(ST_U8,8);if(d){let l=a.getNextSample(ST_U8,2);for(let o=0;o<d;o++){let o=t.series[s].uncompressSamples[t.series[s].uncompressSamples.length-1].data_relative_timestamp,d={data_relative_timestamp:0,data:{}},r=a.getNextBifromHi(l);if(d.data_relative_timestamp=computeTimestampFromBi(a,o,r),d.data_relative_timestamp>i&&(i=d.data_relative_timestamp),r=a.getNextBifromHi(t.series[s].codingTable),r<=BR_HUFF_MAX_i1_TABLE){let i=t.series[s].uncompressSamples[t.series[s].uncompressSamples.length-1].data.value;d.data.value=r>0?completeCurrentMeasure(a,i,t.series[s].codingType,e[s].resol,r):i}else d.data.value=a.getNextSample(e[s].sampletype);t.series[s].uncompressSamples.push(d)}}}return i}function adaptToExpectedFormat(t,a,e){let i={batch_counter:t.batch_counter,batch_relative_timestamp:t.batch_relative_timestamp};return e&&(i.batch_absolute_timestamp=e),i.dataset=t.series.reduce((function(i,s,l){return i.concat(s.uncompressSamples.map((function(i){let s={data_relative_timestamp:i.data_relative_timestamp,data:{value:a[l].divide?i.data.value/a[l].divide:i.data.value,label:a[l].taglbl}};return a[l].lblname&&(s.data.label_name=a[l].lblname),e&&(s.data_absolute_timestamp=computeDataAbsoluteTimestamp(e,t.batch_relative_timestamp,i.data_relative_timestamp)),s})))}),[]),i}function computeDataAbsoluteTimestamp(t,a,e){return new Date(new Date(t)-1e3*(a-e)).toISOString()}function normalisation_batch(t){let a=t.date,e=brUncompress(t.batch1,t.batch2,t.payload,a);console.log(e);let i=[];for(let t=0;t<e.dataset.length;t++){let a=e.dataset[t],s={variable:a.data.label_name,value:a.data.value,date:a.data_absolute_timestamp};i.push(s)}return i}function watteco_decodeUplink(t,a,e){t.bytes,t.fPort;let i=t.recvTime;try{let s=normalisation_standard(t,e),l=s.payload;if("batch"!==s.type)return{data:s.data,warnings:[s.warning]};{let t={batch1:a[0],batch2:a[1],payload:l,date:i};try{return{data:normalisation_batch(t),warnings:[""]}}catch(t){return{error:t.message,warnings:[""]}}}}catch(t){return{error:t.message,warnings:[""]}}}Math.trunc=Math.trunc||function(t){return isNaN(t)?NaN:t>0?Math.floor(t):Math.ceil(t)};let batch_param=[2,[{taglbl:0,resol:10,sampletype:7,lblname:"temperature",divide:100},{taglbl:1,resol:100,sampletype:6,lblname:"humidity",divide:100},{taglbl:2,resol:1,sampletype:6,lblname:"battery_voltage",divide:1e3},{taglbl:3,resol:1,sampletype:1,lblname:"open_case",divide:1}]];function decodeUplink(t){return result=watteco_decodeUplink(t,batch_param)}module.exports.decodeUplink=decodeUplink;